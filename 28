(function() {
    'use strict';

    // Check if the current URL includes "GenerateCaptcha" and exit if it does
    if (window.location.href.includes("/GenerateCaptcha")) {
        return;
    }

    // Namespace to encapsulate all functions and variables
    const myScript = {
        loadScript: function(url, callback) {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = url;
            script.onload = callback;
            document.head.appendChild(script);
        },

        loadStylesheet: function(url) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = url;
            document.head.appendChild(link);
        },

        initialize: function() {
            // Default settings to be set to true
            const defaultSettings = [
                'Auto Refresh',
                'Auto Select Date',
                'Auto Upload Photo',
                'Auto Paypass Captcha',
                'Auto Send Otp',
                'Auto Selfi',
                'Auto skip'
            ];

            // Set default settings to true if they are not already set
            defaultSettings.forEach(setting => {
                if (localStorage.getItem(setting) === null) {
                    localStorage.setItem(setting, 'true');
                }
            });

            // Create buttons and menus
            myScript.createButtons();
            myScript.createConfigMenu();
            myScript.createDatePickerMenu();
        },

        createButton: function(text, onClickFunction, color, topOffset) {
            var button = document.createElement("button");
            button.innerHTML = text;
            button.style.position = "fixed";
            button.style.top = topOffset + "px";
            button.style.right = "10px";
            button.style.zIndex = "10001";
            button.style.padding = "10px 20px";
            button.style.background = `linear-gradient(to bottom, ${color[0]}, ${color[1]})`;
            button.style.color = "white";
            button.style.border = "none";
            button.style.cursor = "pointer";
            button.style.borderRadius = "20px";
            button.style.userSelect = "none";
            button.style.fontSize = "16px";
            button.style.fontWeight = "bold";
            button.style.boxShadow = "0 4px 8px 0 rgba(0, 0, 0, 0.2)";
            button.style.textShadow = "1px 1px 2px rgba(0, 0, 0, 0.5)";
            button.style.transition = "transform 0.2s";

            button.addEventListener("click", onClickFunction);

            button.addEventListener("mousedown", function() {
                button.style.transform = "scale(0.95)";
            });
            button.addEventListener("mouseup", function() {
                button.style.transform = "scale(1)";
            });

            // Make the button draggable
            button.onmousedown = function(event) {
                let shiftX = event.clientX - button.getBoundingClientRect().left;
                let shiftY = event.clientY - button.getBoundingClientRect().top;

                function moveAt(pageX, pageY) {
                    button.style.left = pageX - shiftX + 'px';
                    button.style.top = pageY - shiftY + 'px';
                }

                function onMouseMove(event) {
                    moveAt(event.pageX, event.pageY);
                }

                document.addEventListener('mousemove', onMouseMove);

                button.onmouseup = function() {
                    document.removeEventListener('mousemove', onMouseMove);
                    button.onmouseup = null;
                };

                button.onmouseleave = function() {
                    document.removeEventListener('mousemove', onMouseMove);
                    button.onmouseup = null;
                };
            };

            button.ondragstart = function() {
                return false;
            };

            return button;
        },

        createButtons: function() {
            // Config Button
            var configButton = myScript.createButton("Config", function() {
                myScript.configMenu.style.display = myScript.configMenu.style.display === 'none' ? 'block' : 'none';
            }, ["#ff9999", "#ff6666"], 70);
            document.body.appendChild(configButton);

            // Date Refresh Button
            var dateRefreshButton = myScript.createButton("Date Refresh", function() {
                myScript.datePickerMenu.style.display = myScript.datePickerMenu.style.display === 'none' ? 'block' : 'none';
            }, ["#ff9999", "#ff6666"], 130);
            document.body.appendChild(dateRefreshButton);
        },

        createConfigMenu: function() {
            myScript.configMenu = document.createElement('div');
            myScript.configMenu.style.position = 'fixed';
            myScript.configMenu.style.top = '0';
            myScript.configMenu.style.left = '0';
            myScript.configMenu.style.width = '100%';
            myScript.configMenu.style.height = '100%';
            myScript.configMenu.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
            myScript.configMenu.style.border = '1px solid #ccc';
            myScript.configMenu.style.borderRadius = '10px';
            myScript.configMenu.style.display = 'none';
            myScript.configMenu.style.zIndex = '10000';
            myScript.configMenu.style.overflow = 'auto';
            myScript.configMenu.style.padding = '20px';
            document.body.appendChild(myScript.configMenu);

            const options = [
                'Auto Refresh',
                'Auto Select Date',
                'Auto Upload Photo',
                'Auto Paypass Captcha',
                'Auto Send Otp',
                'Auto Selfi',
                'Auto skip'
            ];

            options.forEach(option => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = localStorage.getItem(option) === 'true';
                checkbox.onchange = () => localStorage.setItem(option, checkbox.checked);
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(option));
                myScript.configMenu.appendChild(label);
                myScript.configMenu.appendChild(document.createElement('br'));
            });

            const submitButton = document.createElement('button');
            submitButton.innerText = 'Submit';
            submitButton.style.padding = "10px 20px";
            submitButton.style.background = `linear-gradient(to bottom, #99ff99, #66ff66)`;
            submitButton.style.color = "white";
            submitButton.style.border = "none";
            submitButton.style.cursor = "pointer";
            submitButton.style.borderRadius = "20px";
            submitButton.style.userSelect = "none";
            submitButton.style.fontSize = "16px";
            submitButton.style.fontWeight = "bold";
            submitButton.style.boxShadow = "0 4px 8px 0 rgba(0, 0, 0, 0.2)";
            submitButton.style.textShadow = "1px 1px 2px rgba(0, 0, 0, 0.5)";
            submitButton.style.transition = "transform 0.2s";
            submitButton.addEventListener("mousedown", function() {
                submitButton.style.transform = "scale(0.95)";
            });
            submitButton.addEventListener("mouseup", function() {
                submitButton.style.transform = "scale(1)";
            });
            submitButton.onclick = () => {
                myScript.configMenu.style.display = 'none';
            };
            submitButton.style.position = "relative";
            submitButton.style.marginTop = "10px";
            myScript.configMenu.appendChild(submitButton);
        },

        createDatePickerMenu: function() {
            myScript.datePickerMenu = document.createElement('div');
            myScript.datePickerMenu.style.position = 'fixed';
            myScript.datePickerMenu.style.top = '0';
            myScript.datePickerMenu.style.left = '50%';
            myScript.datePickerMenu.style.transform = 'translateX(-50%)';
            myScript.datePickerMenu.style.width = '50%';
            myScript.datePickerMenu.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
            myScript.datePickerMenu.style.border = '1px solid #ccc';
            myScript.datePickerMenu.style.borderRadius = '10px';
            myScript.datePickerMenu.style.display = 'none';
            myScript.datePickerMenu.style.zIndex = '10000';
            myScript.datePickerMenu.style.overflow = 'auto';
            myScript.datePickerMenu.style.padding = '20px';
            document.body.appendChild(myScript.datePickerMenu);

            const cities = [
                { name: 'CasaNat', label: 'Casablanca (NAT)' },
                { name: 'CasaShengen', label: 'Casablanca (Shengen)' },
                { name: 'Rabat', label: 'Rabat' },
                { name: 'Tetouan', label: 'Tetouan' },
                { name: 'Nador', label: 'Nador' },
                { name: 'Tangier', label: 'Tangier' },
                { name: 'Agadir', label: 'Agadir' }
            ];

            cities.forEach(city => {
                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.alignItems = 'center';
                container.style.marginBottom = '10px';

                const label = document.createElement('label');
                label.innerText = city.label + ': ';
                label.style.fontWeight = 'bold';
                label.style.fontSize = '18px';
                label.style.marginRight = '10px';
                container.appendChild(label);

                const dateInput = document.createElement('input');
                dateInput.id = city.name + 'DatePicker';
                dateInput.style.flex = '1';
                container.appendChild(dateInput);

                const clearButton = document.createElement('button');
                clearButton.innerText = 'Clear';
                clearButton.style.marginLeft = '10px';
                clearButton.style.padding = '5px 10px';
                clearButton.style.background = `linear-gradient(to bottom, #ff9999, #ff6666)`;
                clearButton.style.color = 'white';
                clearButton.style.border = 'none';
                clearButton.style.cursor = 'pointer';
                clearButton.style.borderRadius = '5px';
                clearButton.addEventListener('click', () => myScript.clearDates(city.name));
                container.appendChild(clearButton);

                myScript.datePickerMenu.appendChild(container);

                const fp = flatpickr("#" + city.name + "DatePicker", {
                    mode: "multiple",
                    dateFormat: "Y-m-d",
                    locale: "fr",
                    onClose: myScript.handleDateSelection(city.name)
                });

                const savedDates = JSON.parse(localStorage.getItem(city.name + 'Dates'));
                if (savedDates && savedDates.length > 0) {
                    fp.setDate(savedDates);
                }
            });

            const buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex';
            buttonContainer.style.justifyContent = 'space-between';
            buttonContainer.style.marginTop = '20px';

            const saveButton = document.createElement('button');
            saveButton.innerText = 'Save';
            saveButton.style.padding = '10px 20px';
            saveButton.style.background = `linear-gradient(to bottom, #99ff99, #66ff66)`;
            saveButton.style.color = 'white';
            saveButton.style.border = 'none';
            saveButton.style.cursor = 'pointer';
            saveButton.style.borderRadius = '5px';
            saveButton.addEventListener('click', () => {
                myScript.datePickerMenu.style.display = 'none';
            });
            buttonContainer.appendChild(saveButton);

            const exitButton = document.createElement('button');
            exitButton.innerText = 'Exit';
            exitButton.style.padding = '10px 20px';
            exitButton.style.background = `linear-gradient(to bottom, #ff9999, #ff6666)`;
            exitButton.style.color = 'white';
            exitButton.style.border = 'none';
            exitButton.style.cursor = 'pointer';
            exitButton.style.borderRadius = '5px';
            exitButton.addEventListener('click', () => {
                myScript.datePickerMenu.style.display = 'none';
            });
            buttonContainer.appendChild(exitButton);

            myScript.datePickerMenu.appendChild(buttonContainer);
        },

        handleDateSelection: function(city) {
            return function(selectedDates, dateStr, instance) {
                let cityDatesArray = selectedDates.map(date => instance.formatDate(date, "Y-m-d"));
                localStorage.setItem(city + 'Dates', JSON.stringify(cityDatesArray));
            };
        },

        clearDates: function(city) {
            localStorage.removeItem(city + 'Dates');
            const dateInput = document.getElementById(city + 'DatePicker');
            if (dateInput && dateInput._flatpickr) {
                dateInput._flatpickr.clear();
            }
        }
    };

    // Load flatpickr CSS
    myScript.loadStylesheet('https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.css');

    // Load flatpickr script
    myScript.loadScript('https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.js', function() {
        // Load flatpickr French locale script
        myScript.loadScript('https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/l10n/fr.js', myScript.initialize);
    });
})();

